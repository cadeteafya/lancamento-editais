<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lançamento de editais</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="container">
    <div class="hero">Últimos lançamentos de editais em residência médica:</div>

    <div id="grid" class="grid"></div>

    <div id="pager" class="pager"></div>
  </div>

  <script>
  const PER_PAGE = 9;

  function getPageFromURL() {
    const p = parseInt(new URLSearchParams(location.search).get('p') || '1', 10);
    return Number.isFinite(p) && p > 0 ? p : 1;
  }

  function onlyName(item) {
    // Preferimos 'instituicao' (sigla/nome curto). Se não existir, usa display_title (sem nada extra),
    // e por fim o 'nome' (título do post).
    if (item.instituicao) return item.instituicao;
    if (item.display_title) return item.display_title;
    return item.nome || 'Edital';
  }

  function sortByDate(items) {
    return [...items].sort((a, b) => {
      const da = a.posted_at || a.captured_at || '';
      const db = b.posted_at || b.captured_at || '';
      return db.localeCompare(da); // desc
    });
  }

  function renderCards(items) {
    const grid = document.getElementById('grid');
    grid.innerHTML = items.map(it => {
      const titulo = onlyName(it);
      const href = 'edital.html?slug=' + encodeURIComponent(it.slug);
      return `
        <a class="card-min-link" href="${href}">
          <div class="card card-min">
            <div class="title">${titulo}</div>
            <div class="cta"><em>Ver detalhes</em></div>
          </div>
        </a>
      `;
    }).join('');
  }

  function renderPager(page, totalPages) {
    const el = document.getElementById('pager');
    if (totalPages <= 1) { el.innerHTML = ''; return; }

    const go = (p) => `?p=${p}`;
    const btn = (label, href, cls='pg') => `<a class="${cls}" href="${href}">${label}</a>`;

    // janela de 5 páginas
    const windowSize = 5;
    let start = Math.max(1, page - Math.floor(windowSize/2));
    let end = Math.min(totalPages, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);

    let html = '';
    html += btn('‹', page > 1 ? go(page-1) : '#', 'pg' + (page>1?'':' disabled'));

    for (let p = start; p <= end; p++) {
      html += btn(p, go(p), 'pg' + (p===page?' active':'')); 
    }

    html += btn('›', page < totalPages ? go(page+1) : '#', 'pg' + (page<totalPages?'':' disabled'));

    el.innerHTML = html;
  }

  async function main(){
    const data = await (await fetch('data/editais.json', {cache:'no-store'})).json();
    const items = sortByDate(Array.isArray(data) ? data : []);

    const total = items.length;
    const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    const page = Math.min(getPageFromURL(), totalPages);

    const start = (page - 1) * PER_PAGE;
    const slice = items.slice(start, start + PER_PAGE);

    renderCards(slice);
    renderPager(page, totalPages);
  }

  main().catch(console.error);
  </script>
</body>
</html>
